1.配置文件模块
├── 基础数据路径配置
│ ├── 数据子卷路径
│ │ ├── 路径有效性校验
│ │ └── Btrfs 文件系统检查
│ └── 快照存储路径
├── 保留快照数量（默认使用数量）
│ ├── 最大快照数量限制（默认数量3天）
│ └── 基于时间的保留策略 (默认保留最近3天的快照)
├── 电源检查和使用模式
│ ├── 启用/禁用电源状态检查（默认开启）
| |—— 是否执行脚本（默认仅接入电源线的时候才执行，不使用默认则根据电池阈值设定）
│ └── 电源状态阈值设定 (电池电量低于80% 时不执行，若设置0%则设置为无论电池状态如何均执行脚本)
├── 通知方式
│ ├── 命令行输出通知
│ └── GUI桌面通知或者终端通知（无gui的情况下，将所有通知替换成终端通知）
├── 备份快照错误
│ └── 启用/禁用错误删除（默认启用删除备份错误的快照内容）
├── 最大重试次数
│ ├── 快照创建失败重试次数（默认3次，间隔8s）
│ └── 快照清理失败重试次数（默认3次，间隔8s）
├── 空间警告阈值（二选一默认使用15%的阈值）
│ ├── 百分比阈值设定 (例如：剩余空间低于 X% 时警告)
│ └── 绝对值阈值设定 (例如：剩余空间低于 Y GB 时警告)
├── 最小空间要求（默认5%）
│ ├── 阻止快照的最小剩余空间 (百分比)
│ └── 提示用户清理空间
├── 日志大小限制
│ ├── 最大日志文件大小（默认10M）
│ └── 日志轮转策略 (执行一次输出一次)
└── 备份计划
├── 定时快照信息 (使用 Cron 表达式)
└── 备注如何手动执行快照 (命令行参数)

2. 核心功能脚本 (所有的操作都遵循配置文件的制定内容)

├── 配置检查模块
│ ├── 必填配置验证
│ │ ├── 检查配置项是否存在
│ │ └── 检查配置项是否为空

├── 通知管理模块 (系统通知核心) <-- 模块名称强调
│ ├── 通知方式判断
│ │ └── 自动判断通知方式：GUI 环境使用桌面通知，无 GUI 环境使用终端通知 <-- 更清晰的描述
│ ├── 系统桌面通知处理 (GUI 环境) <-- 更明确的子模块名称
│ │ └── 使用 notify-send 命令发送桌面通知
│ ├── 终端通知处理 (无 GUI 环境) <-- 更明确的子模块名称
│ │ └── 使用 echo 或 print 输出信息到终端
│ └── 日志记录 (所有通知均记录) <-- 新增子模块，强调日志记录
│ └── 将所有通知信息同时记录到日志

│ ├── 目录有效性检查
│ │ ├── 检查路径是否存在
│ │ ├── 检查路径是否为目录
│ │ └── 检查路径是否可访问
│ ├── 文件系统类型验证
│ │ └── 检查路径所在文件系统是否为 Btrfs
│ ├── 写入权限验证
│ │ └── 检查脚本是否对快照存储路径有写入权限
│ └── 错误信息通知 <-- 调整和强调
│ └── 使用系统通知输出具体配置错误信息  (系统通知) <-- 明确系统通知

├── 空间管理模块
│ ├── 空间使用率检查
│ │ ├── 获取 Btrfs 文件系统总空间使用率
│ │ └── 获取数据子卷空间使用率 (可选，更精确)
│ ├── 可用空间检查
│ │ └── 计算 Btrfs 文件系统剩余可用空间
│ ├── 空间警告机制
│ │ ├── 检查空间是否低于警告阈值
│ │ └── 空间不足则发送空间警告通知 (系统通知) <-- 明确系统通知
│ └── 空间不足处理
│ ├── 阻止创建新快照
│ ├── 尝试清理旧快照 (根据保留策略)
│ └── 发送空间不足错误通知 (系统通知) <-- 明确系统通知

├── 电源管理模块
│ ├── 电源状态检测
│ │ ├── 获取当前电源连接状态 (AC/电池)
│ │ └── 获取电池剩余电量 (百分比)
│ ├── 电池供电判断
│ │ └── 判断当前是否为电池供电模式
│ └── 电源策略执行
│ ├── 根据电源配置决定是否执行快照
│ └── 应用电源状态阈值 (例如电池电量百分比)


├── 快照管理模块
│ ├── 空间预检
│ │ └── 在创建快照前执行空间检查 (调用空间管理模块)
│ ├── 创建快照
│ │ ├── 执行 btrfs subvolume snapshot 命令(系统通知) <-- 明确系统通知开始快照
│ │ └── 根据时间戳命名快照 (例如：备份的子卷名字-snapshot-YYYYMMDD-HHMM)
│ └── 错误重试机制
│ ├── 快照创建失败时，根据配置重试
│ └── 达到最大重试次数后，放弃并记录错误 (错误日志)

├── 清理管理模块
│ ├── 清理锁控制
│ │ └── 使用文件锁机制，防止并发清理操作冲突
│ ├── 保留策略执行
│ │ ├── 应用基于快照数量的保留策略
│ │ └── 应用基于时间的保留策略 (例如：保留最近 N 天)
│ └── 旧快照清理
│ └── 执行 btrfs subvolume delete 命令删除过期快照
└── 错误处理模块 (系统通知 & 日志) <-- 模块名称强调

├── 错误日志记录
│ ├── 记录详细错误信息到日志文件 (包含时间戳、错误级别等)
│ ├── 记录原始命令输出和堆栈信息 (便于调试)
│ └── 可配置日志级别 (例如：DEBUG, INFO, WARNING, ERROR)
├── 错误通知发送 (系统通知) <-- 明确系统通知
│ └── 使用系统通知发送错误警告
└── 失败快照清理
  └── 清理创建过程中失败的临时快照 (防止残留)


3. 安装管理脚本 (终端交互增强)

├── 环境检测功能 (终端输出) <-- 强调终端输出
│ ├── 检查 btrfs 命令是否存在 (终端提示)
│ ├── 检查 Python 环境 (如果脚本为 Python，终端提示)
│ └── 检查必要的工具 (例如 notify-send，dialog，终端提示)

├── 依赖管理功能 (终端交互式安装) <-- 更清晰的描述
│ ├── 检测缺失依赖
│ │ └── 扫描环境，列出缺失的必要工具或软件包
│ ├── 终端询问用户是否自动安装 <-- 强调终端询问
│ │ └── 提示用户选择是否尝试自动安装缺失依赖
│ ├── 自动安装依赖 (如果用户允许) <-- 根据用户选择
│ │ └── 使用包管理器 (例如 apt-get install, yum install) 尝试安装
│ └── 安装失败提示 (终端输出) <-- 错误处理
│ └── 如果自动安装失败，提示用户手动安装

├── 终端配置界面 (交互式配置引导) <-- 模块名称更明确
│ ├── 配置模板加载
│ │ └── 加载默认配置文件模板 (首次安装时)
│ ├── 配置项读取
│ │ └── 读取现有配置文件内容 (升级或重新配置时)
│ ├── 交互式配置引导 (终端) <-- 强调终端交互
│ │ ├── 逐项显示配置项及说明 (终端) <-- 终端显示
│ │ ├── 提示用户输入配置值 (终端) <-- 终端输入
│ │ ├── 提供默认值选项 (终端快捷选择)
│ │ └── 提供配置项帮助信息 (终端显示帮助文本)
│ ├── 配置项验证 (实时校验) <-- 强调实时性
│ │ ├── 检查必填项是否已配置 (终端提示)
│ │ ├── 检查配置值格式和有效性 (终端错误提示)
│ │ └── 提供错误提示并允许用户重新输入
│ ├── 配置预览与确认 (终端显示) <-- 终端显示
│ │ ├── 在终端中显示所有配置项及其当前值
│ │ └── 提示用户确认配置或返回修改
│ ├── 配置文件保存
│ │ └── 将用户配置写入配置文件 (覆盖或创建新文件)
│ └── 配置成功提示 (终端) <-- 完成提示
│ └── 终端显示配置保存成功的消息

├── 文件部署功能
│ ├── 部署脚本文件到指定目录 (例如 /usr/local/bin/)
│ └── 部署默认配置文件到指定目录 (例如 /etc/btrfs-autosnap.conf)

├── 服务配置功能 (Systemd 支持) <-- 明确 Systemd
│ ├── 创建 Systemd 服务文件
│ │ └── 生成 Btrfs 自动快照服务的 Systemd 单元文件
│ ├── 启用 Systemd 服务
│ │ └── 使用 systemctl enable 命令启用服务
│ └── 启动 Systemd 服务
│ └── 使用 systemctl start 命令启动服务

└── 权限配置
└── 设置脚本、配置文件、服务文件等必要权限 (chmod 命令)

4. 卸载管理脚本(增强清除功能)

├── 服务停止功能
│ └── 停止 Systemd 服务 (使用 systemctl stop)

├── 文件清理功能
│ ├── 删除脚本文件 
│ └── 删除配置文件 
│ └── 删除 Systemd 服务文件

├── 清除所有自动配置 <-- 更清晰的描述
│ └── 移除所有由安装脚本自动创建或修改的系统配置
│ ├── 删除 Systemd 服务链接 (使用 systemctl disable) <-- 更具体
│ └── 删除可能存在的其他自动配置 (例如：cron 任务 - 如果有的话) <-- 考虑其他配置

└── 快照数据清理 (可选且用户确认) <-- 更明确
├── 提示用户是否删除自动快照 (终端交互) <-- 终端交互
│ └── 终端提示用户是否要删除由脚本创建的快照
├── 删除快照 (如果用户确认) <-- 用户确认后执行
│ └── 如果用户选择删除，则列出并删除所有匹配命名规则的快照
└── 默认保留快照 (不删除为默认行为) <-- 强调默认行为
└── 卸载脚本默认不删除已创建的快照，需要用户明确选择删除


5. 恢复快照脚本

├── 快照选择模块
│ ├── 列出可用快照
│ │ ├── 读取快照存储路径
│ │ └── 扫描快照存储路径，列出符合命名规则的快照
│ ├── 用户选择快照 (终端交互)
│ │ ├── 终端显示可用快照列表 (带时间戳等信息)
│ │ ├── 提示用户输入要恢复的快照名称或编号
│ │ └── 接收用户输入并验证快照选择
│ └── 快照信息展示
│ └── 显示所选快照的详细信息 (例如创建时间、大小等)

├── 恢复前检查模块
│ ├── 检查选定快照是否存在
│ │ └── 验证用户选择的快照路径是否存在且为 Btrfs 子卷
│ ├── 检查目标数据子卷状态
│ │ ├── 检查目标数据子卷是否处于正常状态 (未挂载或可安全替换)
│ │ └── 提示用户备份当前数据子卷 (可选，安全提示)
│ └── 权限验证
│ └── 检查脚本是否对快照和目标路径有读取/写入权限

├── 快照恢复执行模块
│ ├── 创建恢复目标子卷 (从快照)
│ │ ├── 生成新的子卷名称 (例如：原名-restored-YYYYMMDD-HHMM)
│ │ └── 执行 `btrfs subvolume snapshot` 命令从选定快照创建新子卷
│ ├── 挂载恢复子卷 (可选)
│ │ ├──  判断是否需要自动挂载恢复后的子卷 (配置项控制)
│ │ └──  执行 `mount` 命令挂载恢复的子卷到指定位置 (如果配置)
│ └── 用户操作提示 (终端)
│ └── 提示用户恢复操作已完成，并告知新子卷路径 (以及挂载点，如果挂载)

├── 恢复后处理模块
│ ├── 通知发送 (系统通知)
│ │ ├── 发送恢复成功通知 (系统通知)
│ │ └── 发送恢复失败通知 (系统通知，如果恢复过程中出错)
│ ├── 日志记录
│ │ ├── 记录恢复操作详细日志 (包括选择的快照、恢复时间等)
│ │ └── 记录恢复过程中的错误信息 (如果发生)
│ └── 清理临时文件 (如果需要)
│ └──  删除恢复过程中产生的临时文件 (例如临时挂载点)

└── 恢复错误处理模块 (系统通知 & 日志)
├── 错误日志记录
│ ├── 记录详细错误信息到日志文件 (快照选择、恢复执行等阶段错误)
│ └── 记录原始命令输出和堆栈信息 (便于问题排查)
├── 错误通知发送 (系统通知)
│ └── 使用系统通知发送恢复失败的错误警告
└── 恢复中断处理
└──  当恢复操作被用户中断时，进行清理工作 (例如删除未完成的恢复子卷)
